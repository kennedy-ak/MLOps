from mage_ai.io.file import FileIO
from pandas import DataFrame
from mage_ai.data_preparation.decorators import data_exporter

import mlflow
import pickle
from typing import Tuple
from sklearn.linear_model import LinearRegression
from sklearn.feature_extraction import DictVectorizer

@data_exporter
def export_model(dv_lr_tuple: Tuple[DictVectorizer, LinearRegression], **kwargs) -> None:
    """
    Exports the trained model and its DictVectorizer to MLflow.
    """
    dv, lr = dv_lr_tuple
    
    # Set the MLflow tracking URI
    mlflow.set_tracking_uri('http://mlflow:5000')
    
    # Set an experiment name (optional)
    mlflow.set_experiment('my_experiment')
    
    with mlflow.start_run():
        # Log the model. This will create and log the MLmodel artifact.
        mlflow.sklearn.log_model(lr, artifact_path='model', registered_model_name='linear_regression_model')
        
        # Save the DictVectorizer to a file and log it as an artifact
        artifact_path = 'dict_vectorizer.pkl'
        with open(artifact_path, 'wb') as f:
            pickle.dump(dv, f)
        mlflow.log_artifact(artifact_path, artifact_path='artifacts')

        # Optionally, log additional parameters or metrics
        mlflow.log_param("model_type", "linear_regression")
